---
kind: pipeline
type: kubernetes
name: default

platform:
  os: linux
  arch: amd64

steps:
- name: my-build
  pull: if-not-exists
  image: docker:18.03
  commands:
  - docker build -t hocs_serenity_automation .
  - docker run hocs_serenity_automation
  environment:
    DOCKER_HOST: tcp://172.17.0.1:2375
  when:
    branch:
    - master
    event:
    - push

- name: image_to_quay
  pull: if-not-exists
  image: quay.io/ukhomeofficedigital/drone-docker
  settings:
    registry: quay.io
    repo: quay.io/ukhomeofficedigital/hocs-serenity-automation
    tags:
    - build-${DRONE_BUILD_NUMBER}
    - latest
  environment:
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME: ukhomeofficedigital+hocs_quay_robot
  when:
    branch:
    - master
    event:
    - push

- name: tag-docker-image-with-git-tag
  pull: if-not-exists
  image: docker:17.09.1
  commands:
  - docker login -u="ukhomeofficedigital+hocs_quay_robot" -p=$${DOCKER_PASSWORD} quay.io
  - docker tag hocs-serenity-automation quay.io/ukhomeofficedigital/hocs-serenity-automation:$${DRONE_TAG}
  - docker push quay.io/ukhomeofficedigital/hocs-serenity-automation:$${DRONE_TAG}
  environment:
    DOCKER_HOST: tcp://172.17.0.1:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
  when:
    event:
    - tag

- name: execute-tests
  pull: if-not-exists
  image: quay.io/ukhomeofficedigital/hocs-serenity-automation
  commands:
  - sh bin/smoke-tests.sh
  environment:
    ARTIFACTORY_PASSWORD:
      from_secret: artifactory_password
    ARTIFACTORY_USERNAME:
      from_secret: artifactory_username
  when:
    branch:
    - master
    event:
    - push

- name: upload-serenity-report
  pull: if-not-exists
  image: plugins/s3
  settings:
    settings:
      access_key: ${AWS_ACCESS_KEY_ID}
      bucket: ${S3_BUCKET_NAME}
      region: eu-west-2
      secret_key: ${AWS_SECRET_ACCESS_KEY}
      source: target/site/serenity/**/*
      target: /reports/$${DRONE_BUILD_NUMBER}/
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    S3_BUCKET_NAME:
      from_secret: s3_bucket_name
  when:
    branch:
    - master
    event:
    - push
    status:
    - success
    - failure

services:
- name: selenium
  pull: if-not-exists
  image: selenium/hub

- name: chrome
  pull: if-not-exists
  image: selenium/node-chrome
  environment:
    DISPLAY: :99.0
    HUB_PORT_4444_TCP_ADDR: selenium
    HUB_PORT_4444_TCP_PORT: 4444

- name: firefox
  pull: if-not-exists
  image: selenium/node-firefox
  environment:
    DISPLAY: :98.0
    HUB_PORT_4444_TCP_ADDR: selenium
    HUB_PORT_4444_TCP_PORT: 4444

- name: dnd
  image: 340268328991.dkr.ecr.eu-west-2.amazonaws.com/acp/dind

...
